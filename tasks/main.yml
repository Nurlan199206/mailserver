---
  - block: #======For RedHat ========#  
      - name: install nginx for RedHat
        yum: name=nginx state=latest
        notify: nginx start

      - name: install php for RedHat
        yum: name=php state=latest

      - name: install MariaDB for RedHat
        yum: name=mariadb-server state=latest
        notify: mariadb start

      - name: install php-fpm for RedHat
        yum: name=php-fpm state=latest
        notify: php-fpm start

      - name: copy the nginx default for RedHat
        template:
          src: /etc/ansible/roles/ansible-lemp/files/default.j2
          dest: /etc/nginx/conf.d/default.conf
        become: yes

      - name: copy the nginx.conf for RedHat
        copy:
          src: /etc/ansible/roles/ansible-lemp/files/nginx.conf
          dest: /etc/nginx/nginx.conf
        become: yes

      - name: copying t.php file for phpinfo
        copy:
          src: /etc/ansible/roles/ansible-lemp/files/t.php
          dest: /var/www/html/
        become: yes
    when: ansible_os_family == "RedHat"

  - block: #======For Debian ========#
      - name: apt update
        apt: update_cache=yes

      - name: Install mail server packages
        apt:
          name: "{{ packages }}"
        vars:
          packages:
            - apache2
            - postfix
            - dovecot-core
            - dovecot-imapd
            - dovecot-pop3d
            - spamassassin
            - php7.2

      - name: install mysql-server for Debian
        apt: name=mysql-server state=latest update_cache=yes
        notify: mysql start

      - lineinfile:
          path: /etc/dovecot/conf.d/10-mail.conf
          regexp: '^mail_location = mbox:~/mail:INBOX=/var/mail/%u'
          insertafter: '^#   mail_location = maildir:~/Maildir'
        notify: dovecot restart

      - template:
          src: /etc/ansible/roles/mailserver/files/ubuntu/main.cf.j2
          dest: /etc/postfix/main.cf
          notify: postfix restart

      - name: Download roundcube
        get_url: 
          url: https://github.com/roundcube/roundcubemail/releases/download/1.3.8/roundcubemail-1.3.8-complete.tar.gz
          dest: /tmp/
          mode: 0440

      - name: Creates directory /var/www/html/rc
        file:
          path: /var/www/html/rc
          state: directory
          mode: 0775

      - name: Extract roundcube.tar.gz into /var/www/html/rc
        unarchive:
          src: /tmp/roundcubemail-1.3.8-complete.tar.gz
          dest: /tmp/

      - name: rename roundcube directory
        command: mv /tmp/roundcubemail-1.3.8 /tmp/rc

      - name: Move roundcube to /var/www/html
        command: mv /tmp/rc/ /var/www/html/

      - name: service apache2 reload
        service:
          name: apache2
          state: reloaded
    when: ansible_os_family == "Debian"
